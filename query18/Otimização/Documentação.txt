## üß† Estrat√©gia de Otimiza√ß√£o: Substitui√ß√£o de Subconsulta por JOIN

A consulta original utilizava uma subconsulta com o operador `IN`, o que tende a ser menos eficiente em bases grandes. Esse tipo de estrutura faz com que o SGBD precise processar toda a tabela `LINEITEM` para depois realizar a filtragem e jun√ß√£o, o que pode gerar tabelas tempor√°rias e varreduras completas (Full Table Scans).

Para melhorar o desempenho, recomenda-se transformar a subconsulta em uma **jun√ß√£o (JOIN) com uma agrega√ß√£o pr√©-computada**. O otimizador do SGBD costuma lidar melhor com jun√ß√µes, permitindo o uso de √≠ndices e reduzindo o custo total da execu√ß√£o.

---

### üîß Consulta Otimizada

```sql
EXPLAIN ANALYZE
SELECT
    C.C_NAME,
    C.C_CUSTKEY,
    O.O_ORDERKEY,
    O.O_ORDERDATE,
    O.O_TOTALPRICE,
    SUM(L.L_QUANTITY) AS TOTAL_QUANTITY
FROM
    CUSTOMER C
    JOIN ORDERS O ON C.C_CUSTKEY = O.O_CUSTKEY
    JOIN LINEITEM L ON O.O_ORDERKEY = L.L_ORDERKEY
    JOIN (
        SELECT L_ORDERKEY
        FROM LINEITEM
        GROUP BY L_ORDERKEY
        HAVING SUM(L_QUANTITY) > 300
    ) BIG_ORDERS ON BIG_ORDERS.L_ORDERKEY = O.O_ORDERKEY
GROUP BY
    C.C_NAME,
    C.C_CUSTKEY,
    O.O_ORDERKEY,
    O.O_ORDERDATE,
    O.O_TOTALPRICE
ORDER BY
    O.O_TOTALPRICE DESC, O.O_ORDERDATE;
```

---

### ‚úÖ **Vantagens da Otimiza√ß√£o**

1. **Melhor aproveitamento do otimizador do MySQL**
   A subconsulta √© materializada apenas uma vez, permitindo que o MySQL utilize *hash join* ou *merge join*, dependendo do plano de execu√ß√£o.

2. **Redu√ß√£o de compara√ß√µes linha a linha**
   A substitui√ß√£o do `IN (...)` por uma jun√ß√£o elimina verifica√ß√µes individuais, reduzindo o n√∫mero de opera√ß√µes de compara√ß√£o.

3. **Uso de √≠ndices**
   A consulta otimizada permite que √≠ndices sobre `L_ORDERKEY` e `O_ORDERKEY` sejam utilizados para acelerar as jun√ß√µes.

4. **Maior legibilidade e manuten√ß√£o**
   A estrutura de `JOIN` deixa expl√≠citas as rela√ß√µes entre as tabelas, facilitando ajustes e compreens√£o da l√≥gica da consulta.

---

### ‚öôÔ∏è **√çndices Recomendados**

Antes de executar o `EXPLAIN ANALYZE`, √© importante garantir que os seguintes √≠ndices estejam criados para auxiliar o otimizador:

```sql
CREATE INDEX idx_orders_custkey ON ORDERS(O_CUSTKEY);
CREATE INDEX idx_lineitem_orderkey ON LINEITEM(L_ORDERKEY);
CREATE INDEX idx_lineitem_quantity ON LINEITEM(L_QUANTITY);
```

Esses √≠ndices ajudam a:

* Acelerar a jun√ß√£o entre `ORDERS` e `CUSTOMER` (`O_CUSTKEY`);
* Otimizar a rela√ß√£o entre `ORDERS` e `LINEITEM` (`O_ORDERKEY`);
* Melhorar a agrega√ß√£o e o filtro do `HAVING SUM(L_QUANTITY) > 300`.

---

### üîç **Conclus√£o**

A reescrita da consulta utilizando jun√ß√µes expl√≠citas e a cria√ß√£o de √≠ndices estrat√©gicos resultam em uma execu√ß√£o mais eficiente, com menor custo computacional e melhor aproveitamento dos recursos do MySQL.

Essa abordagem √© especialmente recomendada em bancos de dados com alto volume de registros, como os utilizados em benchmarks TPC-H.

---

